WMS.module('Clients', function(Clients, WMS, Backbone, Marionette, $, _) {  Clients.Router = Marionette.AppRouter.extend({    appRoutes: {      "clients(/filter/criterion::criterion)": "listClients"    , "clients/estimates(/id::id)(/code::code)(/client::client)(/from::from)(/to::to)": "listEstimates"    , "clients/orders(/id::id)(/code::code)(/client::client)(/from::from)(/to::to)": "listOrders"    , "clients/notes(/id::id)(/code::code)(/client::client)(/from::from)(/to::to)": "listNotes"    , "clients/invoices(/id::id)(/code::code)(/client::client)(/from::from)(/to::to)": "listInvoices"    , "clients/:id": "showClient"    },        header: 'clients',    permissionsMap: {      'showClient'    : 'client:retrieve'    , 'listClients'   : 'client:list'    , 'listEstimates' : 'clientEstimate:list'    , 'listOrders'    : 'clientOrder:list'    , 'listNotes'     : 'clientNote:list'    , "listInvoices"  : "clientInvoice:list"    }  });    var controllers = Clients.controllers = {}    , API = {    listClients: function(criterion) {      if (!controllers.list) {        controllers.list = new Clients.List.Controller();      }      controllers.list.listClients(criterion);    }  , showClient: function(id) {      if (!controllers.show) {        controllers.show = new Clients.Show.Controller();      }      id    = _.isNaN(parseInt(id)) ? null : parseInt(id);      controllers.show.showClient(id);    }  , listEstimates: function(id, code, client, from, to) {      if (!controllers.estimates) {        console.log("creo nuovo Clients.Estimates.Controller");        controllers.estimates = new Clients.Estimates.Controller();      }      id    = _.isNaN(parseInt(id)) ? null : parseInt(id);      client= _.isNaN(parseInt(client)) ? null : parseInt(client);      from  = Date.parse(from);      to    = Date.parse(to);      controllers.estimates.listEstimates(id, code, client, from, to);    }  , listOrders: function(id, code, client, from, to) {      if (!controllers.orders) {        console.log("creo nuovo Clients.Orders.Controller");        controllers.orders = new Clients.Orders.Controller();               }      id    = _.isNaN(parseInt(id)) ? null : parseInt(id);      client= _.isNaN(parseInt(client)) ? null : parseInt(client);      from  = Date.parse(from);      to    = Date.parse(to);      controllers.orders.listOrders(id, code, client, from, to);    }  , listNotes: function(id, code, client, from, to) {      if (!controllers.notes) {        controllers.notes = new Clients.Notes.Controller();      }      id    = _.isNaN(parseInt(id)) ? null : parseInt(id);      client= _.isNaN(parseInt(client)) ? null : parseInt(client);      from  = Date.parse(from);      to    = Date.parse(to);      controllers.notes.listNotes(id, code, client, from, to);    }  , listInvoices: function(id, code, client, from, to) {      if (!controllers.invoices) {        controllers.invoices = new Clients.Invoices.Controller();      }      id    = _.isNaN(parseInt(id)) ? null : parseInt(id);      client= _.isNaN(parseInt(client)) ? null : parseInt(client);      from  = Date.parse(from);      to    = Date.parse(to);      controllers.invoices.listInvoices(id, code, client, from, to);    }  };    WMS.on('clients:list', function() {    WMS.navigate('clients');  });    WMS.on('clients:filter', function(criterion) {    if (criterion) {      WMS.navigate('clients/filter/criterion:' + criterion);    } else {      WMS.navigate('clients');    }  });    WMS.on('clients:show', function(id) {    WMS.navigate('clients/' + id);  });    var __handleEvent = function(baseURL, options) {    options       = (options || {});    _.defaults(options, {      from: Date.today().addMonths(-1)    , to  : Date.today()    });    var url       = [baseURL];    if (options.id) {      url.push('/id:', options.id);    }    if (options.code) {      url.push('/code:', options.code);    }    if (options.clientId) {      url.push('/client:', options.clientId);    }    url.push('/from:', options.from.toString('yyyy-MM-dd'), '/to:', options.to.toString('yyyy-MM-dd'));    WMS.navigate(url.join(""));  };  WMS.on('clients:estimates:list', function(options) {    __handleEvent('clients/estimates', options);  });    WMS.on('clients:orders:list', function(options) {    __handleEvent('clients/orders', options);  });  WMS.on('clients:notes:list', function(options) {    __handleEvent('clients/notes', options);  });    WMS.on('clients:invoices:list', function(options) {    __handleEvent('clients/invoices', options);  });    WMS.on('before:start', function() {    new Clients.Router({      controller: API    });  });});